<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D布料展开编辑器 | Cloth Flattener</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- 顶部工具栏 -->
        <header class="toolbar">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <path d="M4 8L16 4L28 8V24L16 28L4 24V8Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M4 8L16 12L28 8" stroke="currentColor" stroke-width="2"/>
                    <path d="M16 12V28" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>Cloth Flattener</span>
            </div>
            <div class="toolbar-actions">
                <button class="file-upload-btn" id="load-obj-btn" type="button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="17,8 12,3 7,8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    加载 OBJ
                </button>
                <input type="file" id="obj-input" accept=".obj" style="display:none">
                <button class="file-upload-btn secondary" id="load-json-btn" type="button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    加载缝线 JSON
                </button>
                <input type="file" id="json-input" accept=".json" style="display:none">
                <button class="action-btn" id="segment-btn" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    部件分割
                </button>
                <button class="action-btn primary" id="flatten-btn" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="3" y1="9" x2="21" y2="9"/>
                        <line x1="9" y1="21" x2="9" y2="9"/>
                    </svg>
                    2D展开
                </button>
                <button class="action-btn" id="reset-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                    重置
                </button>
            </div>
            <div class="toolbar-info">
                <span id="model-info">未加载模型</span>
            </div>
        </header>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 左侧3D视图 -->
            <section class="viewport viewport-3d">
                <div class="viewport-header">
                    <span class="viewport-title">3D 视图</span>
                    <div class="viewport-controls">
                        <button class="view-btn" data-view="front" title="正视图">F</button>
                        <button class="view-btn" data-view="top" title="俯视图">T</button>
                        <button class="view-btn" data-view="side" title="侧视图">S</button>
                        <button class="view-btn active" data-view="perspective" title="透视图">P</button>
                    </div>
                </div>
                <div id="canvas-3d" class="canvas-container"></div>
                <div class="viewport-overlay">
                    <div class="axis-indicator" id="axis-3d">
                        <span class="axis-x">X</span>
                        <span class="axis-y">Y</span>
                        <span class="axis-z">Z</span>
                    </div>
                </div>
            </section>

            <!-- 右侧2D视图 -->
            <section class="viewport viewport-2d">
                <div class="viewport-header">
                    <span class="viewport-title">2D 展开视图</span>
                    <div class="viewport-controls">
                        <button class="view-btn" id="fit-view-btn" title="适配视图">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
                            </svg>
                        </button>
                        <button class="view-btn" id="export-svg-btn" title="导出SVG">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="canvas-2d" class="canvas-container"></div>
                <div class="viewport-overlay">
                    <div class="scale-indicator" id="scale-2d">1:1</div>
                </div>
            </section>
        </main>

        <!-- 底部状态栏 -->
        <footer class="statusbar">
            <div class="status-left">
                <span class="status-item" id="vertices-count">顶点: 0</span>
                <span class="status-item" id="faces-count">面: 0</span>
                <span class="status-item" id="seams-count">缝线: 0</span>
            </div>
            <div class="status-center">
                <span class="status-message" id="status-message">就绪</span>
            </div>
            <div class="status-right">
                <span class="status-item" id="flatten-progress" style="display: none;">
                    <span class="progress-bar"><span class="progress-fill"></span></span>
                    <span class="progress-text">0%</span>
                </span>
            </div>
        </footer>

        <!-- 右侧面板 -->
        <aside class="side-panel" id="side-panel">
            <div class="panel-header">
                <span>设置</span>
                <button class="panel-toggle" id="panel-toggle">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15,18 9,12 15,6"/>
                    </svg>
                </button>
            </div>
            <div class="panel-content">
                <div class="panel-section">
                    <h3>展开设置</h3>
                    <div class="setting-item">
                        <label>展开方法</label>
                        <select id="flatten-method">
                            <option value="lscm" selected>LSCM 保角映射 (推荐)</option>
                            <option value="bff">BFF 快速展开</option>
                            <option value="angle-based">基于角度 (ABF)</option>
                            <option value="conformal">共形映射</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>迭代次数</label>
                        <input type="range" id="iterations" min="10" max="200" value="30">
                        <span class="range-value" id="iterations-value">30</span>
                    </div>
                    <div class="setting-item">
                        <label>保持比例</label>
                        <input type="checkbox" id="preserve-ratio" checked>
                    </div>
                </div>
                <div class="panel-section">
                    <h3>显示选项</h3>
                    <div class="setting-item">
                        <label>显示网格</label>
                        <input type="checkbox" id="show-wireframe" checked>
                    </div>
                    <div class="setting-item">
                        <label>显示缝线</label>
                        <input type="checkbox" id="show-seams" checked>
                    </div>
                    <div class="setting-item">
                        <label>缝线颜色</label>
                        <input type="color" id="seam-color" value="#ff3366">
                    </div>
                    <div class="setting-item">
                        <label>背景网格</label>
                        <input type="checkbox" id="show-grid" checked>
                    </div>
                </div>
                <div class="panel-section">
                    <h3>缝线列表</h3>
                    <div class="seam-list" id="seam-list">
                        <div class="empty-state">加载模型后显示缝线</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- 加载提示 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner">
            <svg width="48" height="48" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" stroke-width="3" stroke-dasharray="100" stroke-dashoffset="30">
                    <animateTransform attributeName="transform" type="rotate" from="0 24 24" to="360 24 24" dur="1s" repeatCount="indefinite"/>
                </circle>
            </svg>
        </div>
        <span class="loading-text">处理中...</span>
    </div>

    <!-- 脚本 -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <!-- 文件加载脚本（等待 main.js 模块加载完成后再绑定） -->
    <script>
    // 等待 main.js 模块加载完成
    function waitForApp(callback, maxWait) {
        maxWait = maxWait || 10000;
        var startTime = Date.now();
        
        function check() {
            if (window.app) {
                callback();
            } else if (Date.now() - startTime < maxWait) {
                setTimeout(check, 50);
            } else {
                console.error('等待 window.app 超时');
            }
        }
        check();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM加载完成，等待 main.js 初始化...');
        
        var loadObjBtn = document.getElementById('load-obj-btn');
        var loadJsonBtn = document.getElementById('load-json-btn');
        var objInput = document.getElementById('obj-input');
        var jsonInput = document.getElementById('json-input');
        
        // 按钮点击直接触发文件选择（不依赖 window.app）
        if (loadObjBtn && objInput) {
            loadObjBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('OBJ按钮被点击，触发文件选择');
                objInput.click();
            };
        }
        
        if (loadJsonBtn && jsonInput) {
            loadJsonBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('JSON按钮被点击，触发文件选择');
                jsonInput.click();
            };
        }
        
        // 文件选择后处理（等待 app 就绪）
        if (objInput) {
            objInput.onchange = function(e) {
                var files = e.target.files;
                console.log('OBJ文件已选择:', files);
                
                if (files && files[0]) {
                    var file = files[0];
                    
                    if (window.app) {
                        console.log('直接调用 app.loadOBJFile...');
                        window.app.loadOBJFile(file);
                    } else {
                        console.log('等待 app 初始化...');
                        waitForApp(function() {
                            console.log('app 就绪，调用 loadOBJFile...');
                            window.app.loadOBJFile(file);
                        });
                    }
                }
                e.target.value = ''; // 清空以便重复选择
            };
        }
        
        if (jsonInput) {
            jsonInput.onchange = function(e) {
                var files = e.target.files;
                console.log('JSON文件已选择:', files);
                
                if (files && files[0]) {
                    var file = files[0];
                    
                    if (window.app) {
                        console.log('直接调用 app.loadSeamJSON...');
                        window.app.loadSeamJSON(file);
                    } else {
                        console.log('等待 app 初始化...');
                        waitForApp(function() {
                            console.log('app 就绪，调用 loadSeamJSON...');
                            window.app.loadSeamJSON(file);
                        });
                    }
                }
                e.target.value = ''; // 清空以便重复选择
            };
        }
    });
    </script>
    
    <script type="module" src="js/main.js"></script>
    <script type="module">
        // 检测模块加载状态
        setTimeout(() => {
            if (!window.app) {
                console.error('main.js 模块在3秒后仍未初始化 window.app');
                console.log('请检查 Network 标签页中是否有加载失败的资源');
            }
        }, 3000);
    </script>
    <script>
        // 捕获模块加载错误
        window.addEventListener('error', function(e) {
            console.error('全局错误:', e.message, e.filename, e.lineno);
        });
        window.addEventListener('unhandledrejection', function(e) {
            console.error('未处理的Promise拒绝:', e.reason);
        });
    </script>
</body>
</html>

